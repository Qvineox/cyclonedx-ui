import {Fragment} from "react";

import DataTable from 'datatables.net-react';
import DT from 'datatables.net-bs5';

import type {IRating, IVulnerability} from "../../types/sbom.ts";

import Badge from 'react-bootstrap/Badge';
import Stack from 'react-bootstrap/Stack';
import renderMaxSeverityCell from "../cellRenderers/max-severity.tsx";
import renderAffectedCell from "../cellRenderers/affected.tsx";
import {renderToString} from "react-dom/server";

interface IVulnerabilityListProps {
    vulnerabilities: IVulnerability[]
}

const renderRatingsCell = (data: Array<IRating>, row) => {
    return <Stack direction="vertical" gap={1}>
        {data.map((value, index) => {
            console.log(value.source)

            const [bgColor, textColor] = severityColor(value.severity)

            return <Badge onClick={() => window.open(value.source.url)}
                          bg={bgColor}
                          text={textColor}
                          key={index}>
                {value.source.source} {value.score}
            </Badge>
        })}
    </Stack>
}

const severityColor = (severity: string): Array<string> => {
    switch (severity) {
        case "critical":
            return ["dark", "white"]
        case "high":
            return ["danger", "dark"]
        case "medium":
            return ["warning", "dark"]
        case "low":
            return ["warning", "dark"]
        case "info":
            return ["primary", "dark"]
        default:
            return ["secondary", "dark"]
    }

}

const columns = [
    {data: 'id', title: 'ID', type: 'string', width: '10%'},
    {data: 'source.source', title: 'Source', type: 'string', width: "5%"},
    {data: 'description', className: 'description', title: 'Description', type: 'string', width: 'auto'},
    {data: 'recommendation', className: 'fix', title: 'Fix', type: 'string', width: "10%"},
    {
        data: 'maxRating',
        title: 'Max rating',
        width: '7%',
        render(data, type, row, meta) {
            return renderToString(renderMaxSeverityCell(data));
        },
    },
    {
        data: 'ratings', title: 'Severity', type: 'slots', width: "6%",
        render(data, type, row, meta) {
            return renderToString(renderRatingsCell(data));
        },
    },
    {
        data: 'affects', title: 'Affected', type: 'html', width: "10%",
        render(data, type, row, meta) {
            return renderToString(renderAffectedCell(data));
        },
    },
    {data: 'updatedAt', title: 'Updated at', render: DT.render.datetime(), width: "10%"},
]

// const sample: Array<IVulnerability> = [
//     {
//         "id": "CVE-2023-45857",
//         "source": {
//             "source": "ghsa",
//             "url": "https://github.com/advisories?query=type%3Areviewed+ecosystem%3Anpm"
//         },
//         "description": "An issue discovered in Axios 1.5.1 inadvertently reveals the confidential XSRF-TOKEN stored in cookies by including it in the HTTP header X-XSRF-TOKEN for every request made to any host allowing attackers to view sensitive information.",
//         "detail": "",
//         "recommendation": "Upgrade axios to version 1.6.0, 0.28.0",
//         "ratings": [
//             {
//                 "source": {
//                     "source": "ghsa",
//                     "url": ""
//                 },
//                 "score": 6.5,
//                 "severity": "medium",
//                 "method": "CVSSv31",
//                 "vector": "CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:U/C:H/I:N/A:N",
//                 "justification": ""
//             },
//             {
//                 "source": {
//                     "source": "nvd",
//                     "url": ""
//                 },
//                 "score": 6.5,
//                 "severity": "medium",
//                 "method": "CVSSv31",
//                 "vector": "CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:U/C:H/I:N/A:N",
//                 "justification": ""
//             },
//             {
//                 "source": {
//                     "source": "redhat",
//                     "url": ""
//                 },
//                 "score": 6.5,
//                 "severity": "medium",
//                 "method": "CVSSv31",
//                 "vector": "CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:U/C:H/I:N/A:N",
//                 "justification": ""
//             }
//         ],
//         "cwes": [
//             352
//         ],
//         "advisories": [
//             {
//                 "title": "",
//                 "url": "https://avd.aquasec.com/nvd/cve-2023-45857"
//             },
//             {
//                 "title": "",
//                 "url": "https://access.redhat.com/security/cve/CVE-2023-45857"
//             },
//             {
//                 "title": "",
//                 "url": "https://github.com/axios/axios"
//             },
//             {
//                 "title": "",
//                 "url": "https://github.com/axios/axios/commit/2755df562b9c194fba6d8b609a383443f6a6e967"
//             },
//             {
//                 "title": "",
//                 "url": "https://github.com/axios/axios/commit/96ee232bd3ee4de2e657333d4d2191cd389e14d0"
//             },
//             {
//                 "title": "",
//                 "url": "https://github.com/axios/axios/issues/6006"
//             },
//             {
//                 "title": "",
//                 "url": "https://github.com/axios/axios/issues/6022"
//             },
//             {
//                 "title": "",
//                 "url": "https://github.com/axios/axios/pull/6028"
//             },
//             {
//                 "title": "",
//                 "url": "https://github.com/axios/axios/pull/6091"
//             },
//             {
//                 "title": "",
//                 "url": "https://github.com/axios/axios/releases/tag/v0.28.0"
//             },
//             {
//                 "title": "",
//                 "url": "https://github.com/axios/axios/releases/tag/v1.6.0"
//             },
//             {
//                 "title": "",
//                 "url": "https://nvd.nist.gov/vuln/detail/CVE-2023-45857"
//             },
//             {
//                 "title": "",
//                 "url": "https://security.netapp.com/advisory/ntap-20240621-0006"
//             },
//             {
//                 "title": "",
//                 "url": "https://security.netapp.com/advisory/ntap-20240621-0006/"
//             },
//             {
//                 "title": "",
//                 "url": "https://security.snyk.io/vuln/SNYK-JS-AXIOS-6032459"
//             },
//             {
//                 "title": "",
//                 "url": "https://www.cve.org/CVERecord?id=CVE-2023-45857"
//             }
//         ],
//         "affects": [
//             {
//                 "ranges": [
//                     {
//                         "version": "0.27.2",
//                         "range": "",
//                         "status": "affected"
//                     }
//                 ]
//             }
//         ],
//         "publishedAt": "2023-11-08T21:15:08Z",
//         "updatedAt": "2024-11-21T08:27:30Z"
//     },
//     {
//         "id": "CVE-2025-27152",
//         "source": {
//             "source": "ghsa",
//             "url": "https://github.com/advisories?query=type%3Areviewed+ecosystem%3Anpm"
//         },
//         "description": "axios is a promise based HTTP client for the browser and node.js. The issue occurs when passing absolute URLs rather than protocol-relative URLs to axios. Even if ‚Å†baseURL is set, axios sends the request to the specified absolute URL, potentially causing SSRF and credential leakage. This issue impacts both server-side and client-side usage of axios. This issue is fixed in 1.8.2.",
//         "detail": "",
//         "recommendation": "Upgrade axios to version 1.8.2, 0.30.0",
//         "ratings": [
//             {
//                 "source": {
//                     "source": "ghsa",
//                     "url": ""
//                 },
//                 "severity": "high",
//                 "method": "",
//                 "vector": "",
//                 "justification": ""
//             },
//             {
//                 "source": {
//                     "source": "nvd",
//                     "url": ""
//                 },
//                 "score": 7.5,
//                 "severity": "high",
//                 "method": "CVSSv31",
//                 "vector": "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:N/A:N",
//                 "justification": ""
//             },
//             {
//                 "source": {
//                     "source": "redhat",
//                     "url": ""
//                 },
//                 "score": 5.3,
//                 "severity": "medium",
//                 "method": "CVSSv31",
//                 "vector": "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:L/I:N/A:N",
//                 "justification": ""
//             }
//         ],
//         "cwes": [
//             918
//         ],
//         "advisories": [
//             {
//                 "title": "",
//                 "url": "https://avd.aquasec.com/nvd/cve-2025-27152"
//             },
//             {
//                 "title": "",
//                 "url": "https://access.redhat.com/security/cve/CVE-2025-27152"
//             },
//             {
//                 "title": "",
//                 "url": "https://github.com/axios/axios"
//             },
//             {
//                 "title": "",
//                 "url": "https://github.com/axios/axios/commit/02c3c69ced0f8fd86407c23203835892313d7fde"
//             },
//             {
//                 "title": "",
//                 "url": "https://github.com/axios/axios/commit/fb8eec214ce7744b5ca787f2c3b8339b2f54b00f"
//             },
//             {
//                 "title": "",
//                 "url": "https://github.com/axios/axios/issues/6463"
//             },
//             {
//                 "title": "",
//                 "url": "https://github.com/axios/axios/pull/6829"
//             },
//             {
//                 "title": "",
//                 "url": "https://github.com/axios/axios/releases/tag/v1.8.2"
//             },
//             {
//                 "title": "",
//                 "url": "https://github.com/axios/axios/security/advisories/GHSA-jr5f-v2jv-69x6"
//             },
//             {
//                 "title": "",
//                 "url": "https://nvd.nist.gov/vuln/detail/CVE-2025-27152"
//             },
//             {
//                 "title": "",
//                 "url": "https://www.cve.org/CVERecord?id=CVE-2025-27152"
//             }
//         ],
//         "affects": [
//             {
//                 "ranges": [
//                     {
//                         "version": "0.27.2",
//                         "range": "",
//                         "status": "affected"
//                     }
//                 ]
//             }
//         ],
//         "publishedAt": "2025-03-07T16:15:38Z",
//         "updatedAt": "2025-09-22T18:52:22Z"
//     },
//     {
//         "id": "CVE-2025-30359",
//         "source": {
//             "source": "ghsa",
//             "url": "https://github.com/advisories?query=type%3Areviewed+ecosystem%3Anpm"
//         },
//         "description": "webpack-dev-server allows users to use webpack with a development server that provides live reloading. Prior to version 5.2.1, webpack-dev-server users' source code may be stolen when they access a malicious web site. Because the request for classic script by a script tag is not subject to same origin policy, an attacker can inject a malicious script in their site and run the script. Note that the attacker has to know the port and the output entrypoint script path. Combined with prototype pollution, the attacker can get a reference to the webpack runtime variables. By using `Function::toString` against the values in `__webpack_modules__`, the attacker can get the source code. Version 5.2.1 contains a patch for the issue.",
//         "detail": "",
//         "recommendation": "Upgrade webpack-dev-server to version 5.2.1",
//         "ratings": [
//             {
//                 "source": {
//                     "source": "ghsa",
//                     "url": ""
//                 },
//                 "score": 5.3,
//                 "severity": "medium",
//                 "method": "CVSSv31",
//                 "vector": "CVSS:3.1/AV:N/AC:H/PR:N/UI:R/S:U/C:H/I:N/A:N",
//                 "justification": ""
//             },
//             {
//                 "source": {
//                     "source": "redhat",
//                     "url": ""
//                 },
//                 "score": 5.3,
//                 "severity": "medium",
//                 "method": "CVSSv31",
//                 "vector": "CVSS:3.1/AV:N/AC:H/PR:N/UI:R/S:U/C:H/I:N/A:N",
//                 "justification": ""
//             }
//         ],
//         "cwes": [
//             749
//         ],
//         "advisories": [
//             {
//                 "title": "",
//                 "url": "https://avd.aquasec.com/nvd/cve-2025-30359"
//             },
//             {
//                 "title": "",
//                 "url": "https://access.redhat.com/security/cve/CVE-2025-30359"
//             },
//             {
//                 "title": "",
//                 "url": "https://github.com/webpack/webpack-dev-server"
//             },
//             {
//                 "title": "",
//                 "url": "https://github.com/webpack/webpack-dev-server/commit/5c9378bb01276357d7af208a0856ca2163db188e"
//             },
//             {
//                 "title": "",
//                 "url": "https://github.com/webpack/webpack-dev-server/commit/d2575ad8dfed9207ed810b5ea0ccf465115a2239"
//             },
//             {
//                 "title": "",
//                 "url": "https://github.com/webpack/webpack-dev-server/security/advisories/GHSA-4v9v-hfq4-rm2v"
//             },
//             {
//                 "title": "",
//                 "url": "https://nvd.nist.gov/vuln/detail/CVE-2025-30359"
//             },
//             {
//                 "title": "",
//                 "url": "https://www.cve.org/CVERecord?id=CVE-2025-30359"
//             }
//         ],
//         "affects": [
//             {
//                 "ranges": [
//                     {
//                         "version": "5.2.0",
//                         "range": "",
//                         "status": "affected"
//                     }
//                 ]
//             }
//         ],
//         "publishedAt": "2025-06-03T18:15:25Z",
//         "updatedAt": "2025-06-04T14:54:33Z"
//     },
//     {
//         "id": "CVE-2025-30360",
//         "source": {
//             "source": "ghsa",
//             "url": "https://github.com/advisories?query=type%3Areviewed+ecosystem%3Anpm"
//         },
//         "description": "webpack-dev-server allows users to use webpack with a development server that provides live reloading. Prior to version 5.2.1, webpack-dev-server users' source code may be stolen when you access a malicious web site with non-Chromium based browser. The `Origin` header is checked to prevent Cross-site WebSocket hijacking from happening, which was reported by CVE-2018-14732. But webpack-dev-server always allows IP address `Origin` headers. This allows websites that are served on IP addresses to connect WebSocket. An attacker can obtain source code via a method similar to that used to exploit CVE-2018-14732. Version 5.2.1 contains a patch for the issue.",
//         "detail": "",
//         "recommendation": "Upgrade webpack-dev-server to version 5.2.1",
//         "ratings": [
//             {
//                 "source": {
//                     "source": "ghsa",
//                     "url": ""
//                 },
//                 "score": 6.5,
//                 "severity": "medium",
//                 "method": "CVSSv31",
//                 "vector": "CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:U/C:H/I:N/A:N",
//                 "justification": ""
//             },
//             {
//                 "source": {
//                     "source": "redhat",
//                     "url": ""
//                 },
//                 "score": 6.5,
//                 "severity": "medium",
//                 "method": "CVSSv31",
//                 "vector": "CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:U/C:H/I:N/A:N",
//                 "justification": ""
//             }
//         ],
//         "cwes": [
//             346
//         ],
//         "advisories": [
//             {
//                 "title": "",
//                 "url": "https://avd.aquasec.com/nvd/cve-2025-30360"
//             },
//             {
//                 "title": "",
//                 "url": "https://access.redhat.com/security/cve/CVE-2025-30360"
//             },
//             {
//                 "title": "",
//                 "url": "https://github.com/webpack/webpack-dev-server"
//             },
//             {
//                 "title": "",
//                 "url": "https://github.com/webpack/webpack-dev-server/blob/55220a800ba4e30dbde2d98785ecf4c80b32f711/lib/Server.js#L3113-L3127"
//             },
//             {
//                 "title": "",
//                 "url": "https://github.com/webpack/webpack-dev-server/commit/5c9378bb01276357d7af208a0856ca2163db188e"
//             },
//             {
//                 "title": "",
//                 "url": "https://github.com/webpack/webpack-dev-server/commit/72efaab83381a0e1c4914adf401cbd210b7de7eb"
//             },
//             {
//                 "title": "",
//                 "url": "https://github.com/webpack/webpack-dev-server/commit/d2575ad8dfed9207ed810b5ea0ccf465115a2239"
//             },
//             {
//                 "title": "",
//                 "url": "https://github.com/webpack/webpack-dev-server/security/advisories/GHSA-9jgg-88mc-972h"
//             },
//             {
//                 "title": "",
//                 "url": "https://nvd.nist.gov/vuln/detail/CVE-2025-30360"
//             },
//             {
//                 "title": "",
//                 "url": "https://www.cve.org/CVERecord?id=CVE-2025-30360"
//             }
//         ],
//         "affects": [
//             {
//                 "ranges": [
//                     {
//                         "version": "5.2.0",
//                         "range": "",
//                         "status": "affected"
//                     }
//                 ]
//             }
//         ],
//         "publishedAt": "2025-06-03T18:15:25Z",
//         "updatedAt": "2025-06-04T14:54:33Z"
//     },
//     {
//         "id": "CVE-2025-58754",
//         "source": {
//             "source": "ghsa",
//             "url": "https://github.com/advisories?query=type%3Areviewed+ecosystem%3Anpm"
//         },
//         "description": "Axios is a promise based HTTP client for the browser and Node.js. When Axios prior to versions 0.30.2 and 1.12.0 runs on Node.js and is given a URL with the `data:` scheme, it does not perform HTTP. Instead, its Node http adapter decodes the entire payload into memory (`Buffer`/`Blob`) and returns a synthetic 200 response. This path ignores `maxContentLength` / `maxBodyLength` (which only protect HTTP responses), so an attacker can supply a very large `data:` URI and cause the process to allocate unbounded memory and crash (DoS), even if the caller requested `responseType: 'stream'`. Versions 0.30.2 and 1.12.0 contain a patch for the issue.",
//         "detail": "",
//         "recommendation": "Upgrade axios to version 1.12.0, 0.30.2",
//         "ratings": [
//             {
//                 "source": {
//                     "source": "ghsa",
//                     "url": ""
//                 },
//                 "score": 7.5,
//                 "severity": "high",
//                 "method": "CVSSv31",
//                 "vector": "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:N/A:H",
//                 "justification": ""
//             },
//             {
//                 "source": {
//                     "source": "redhat",
//                     "url": ""
//                 },
//                 "score": 5.3,
//                 "severity": "medium",
//                 "method": "CVSSv31",
//                 "vector": "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:N/A:L",
//                 "justification": ""
//             }
//         ],
//         "cwes": [
//             770
//         ],
//         "advisories": [
//             {
//                 "title": "",
//                 "url": "https://avd.aquasec.com/nvd/cve-2025-58754"
//             },
//             {
//                 "title": "",
//                 "url": "https://access.redhat.com/security/cve/CVE-2025-58754"
//             },
//             {
//                 "title": "",
//                 "url": "https://github.com/axios/axios"
//             },
//             {
//                 "title": "",
//                 "url": "https://github.com/axios/axios/commit/945435fc51467303768202250debb8d4ae892593"
//             },
//             {
//                 "title": "",
//                 "url": "https://github.com/axios/axios/commit/a1b1d3f073a988601583a604f5f9f5d05a3d0b67"
//             },
//             {
//                 "title": "",
//                 "url": "https://github.com/axios/axios/pull/7011"
//             },
//             {
//                 "title": "",
//                 "url": "https://github.com/axios/axios/pull/7034"
//             },
//             {
//                 "title": "",
//                 "url": "https://github.com/axios/axios/releases/tag/v0.30.2"
//             },
//             {
//                 "title": "",
//                 "url": "https://github.com/axios/axios/releases/tag/v1.12.0"
//             },
//             {
//                 "title": "",
//                 "url": "https://github.com/axios/axios/security/advisories/GHSA-4hjh-wcwx-xvwj"
//             },
//             {
//                 "title": "",
//                 "url": "https://nvd.nist.gov/vuln/detail/CVE-2025-58754"
//             },
//             {
//                 "title": "",
//                 "url": "https://www.cve.org/CVERecord?id=CVE-2025-58754"
//             }
//         ],
//         "affects": [
//             {
//                 "ranges": [
//                     {
//                         "version": "0.27.2",
//                         "range": "",
//                         "status": "affected"
//                     }
//                 ]
//             },
//             {
//                 "ranges": [
//                     {
//                         "version": "1.11.0",
//                         "range": "",
//                         "status": "affected"
//                     }
//                 ]
//             },
//             {
//                 "ranges": [
//                     {
//                         "version": "1.8.4",
//                         "range": "",
//                         "status": "affected"
//                     }
//                 ]
//             },
//             {
//                 "ranges": [
//                     {
//                         "version": "1.9.0",
//                         "range": "",
//                         "status": "affected"
//                     }
//                 ]
//             }
//         ],
//         "publishedAt": "2025-09-12T02:15:46Z",
//         "updatedAt": "2025-09-29T15:16:08Z"
//     }
// ]

export default function VulnerabilityList(props: IVulnerabilityListProps) {
    return <Fragment>
        <DataTable className={"table table-striped"}
                   columns={columns}
                   data={props.vulnerabilities}
                   options={{
                       autoWidth: true,
                       paging: true
                   }}>
            <thead>
            <tr>
                <th>ID</th>
                <th>Description</th>
                <th>Fix</th>
            </tr>
            </thead>
        </DataTable>
    </Fragment>
}